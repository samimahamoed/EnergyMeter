\hypertarget{a00042}{\section{srv\-\_\-cmd\-\_\-handler.\-c}
\label{d5/db6/a00042}\index{srv\-\_\-cmd\-\_\-handler.\-c@{srv\-\_\-cmd\-\_\-handler.\-c}}
}

\begin{DoxyCode}
00001 
00006 \textcolor{preprocessor}{#include "../includes/includes.h"}
00007 
00008 
00013 
00014 
00039 
\hypertarget{a00042_source_l00040}{}\hyperlink{a00009_gac914ebaa64afce03ee852af09659cf69}{00040} \textcolor{keywordtype}{float} \hyperlink{a00009_gac914ebaa64afce03ee852af09659cf69}{measure}(uint8\_t cmd,uint8\_t channel,\textcolor{keywordtype}{float} samples)\{
00041 
00042 
00043     \textcolor{keywordtype}{float} measured\_val=0;
00044 
00045 
00046          \textcolor{keywordflow}{switch}(cmd)
00047         \{
00048            
00049                 \textcolor{keywordflow}{case}  \hyperlink{a00043_af0c09c5a455410e6fbd35fd55221338f}{PHASE\_VRMS}:
00050                 \{
00051                                 
00052                     uint16\_t ii;
00053                     uint16\_t target\_reg =  (channel==\hyperlink{a00043_ad214039f52b011ce2bd6c85ff98a981b}{PHASE\_A} )?\hyperlink{a00036_ae4c7fedd5702010e6907a686a35c1fa8}{AVRMS}
00054                                           :(channel==\hyperlink{a00043_ad7b96feed1e1c12515dad5e926b2c62e}{PHASE\_B} )?\hyperlink{a00036_a09f7027a92ccae6bb9b5738d5bc185f3}{BVRMS}
00055                                           :(channel==\hyperlink{a00043_a3ceb83fb10c2af19b468d508448f24e2}{PHASE\_C} )?\hyperlink{a00036_a61e9291ce0829a45cee1ee9a5f3ea4f7}{CVRMS}
00056                                           :0;                               
00057                     
00058                     \textcolor{keywordflow}{if}(target\_reg==0)\textcolor{keywordflow}{return} -1;                         
00059                     \textcolor{keywordflow}{for}(ii=0;ii<samples;ii++)\{
00060                     \textcolor{keywordflow}{if}(\hyperlink{a00003_ga7b6d584350762c53419945480d6958d3}{wait\_new\_conversion}()==-1)\textcolor{keywordflow}{return} -1;
00061                     measured\_val += (uint32\_t)(\hyperlink{a00007_ga7ad9f65ee46aca507374096506a0b1c4}{spi\_read}(BCM2835\_SPI\_CS0,
      \hyperlink{a00037_a94de2b046db6e10257ef4481c0a15eaa}{CHIP\_ADDRESS1},target\_reg,\textcolor{keyword}{sizeof}(uint32\_t))&0xFFFFFF)*
      \hyperlink{a00037_abcedc82a86b3c2ac9850cb7c6f5e7a9b}{TRANSFORMER\_RATIO}; 
00062                     \textcolor{keywordflow}{if}(ii%50 == 0)printf(\textcolor{stringliteral}{"#\(\backslash\)n"});\textcolor{keywordflow}{else} printf(\textcolor{stringliteral}{"#"});
00063                     \}
00064                     measured\_val /=samples;
00065                     
00066             
00067                     \textcolor{keywordflow}{return} measured\_val/\hyperlink{a00037_aef67453964ff5f4b43fa56b18cee9925}{VLSB\_CONST};
00068                 
00069                 \}\textcolor{keywordflow}{break};
00070 
00071                 \textcolor{keywordflow}{case}  \hyperlink{a00043_a15c9ccf287820001431c33c4bb25a23b}{PHASE\_IRMS}:
00072                 \{
00073                     uint16\_t ii;
00074                     uint16\_t target\_reg =  (channel==\hyperlink{a00043_ad214039f52b011ce2bd6c85ff98a981b}{PHASE\_A} )?\hyperlink{a00036_afae37e821d8947e31a63759e4bb57355}{AIRMS}
00075                                           :(channel==\hyperlink{a00043_ad7b96feed1e1c12515dad5e926b2c62e}{PHASE\_B} )?\hyperlink{a00036_ae1cff66a3f5c466b4344a5c2781224df}{BIRMS}
00076                                           :(channel==\hyperlink{a00043_a3ceb83fb10c2af19b468d508448f24e2}{PHASE\_C} )?\hyperlink{a00036_a3ccd0ef2a55b24f358292694724d37a3}{CIRMS}
00077                                           :0;
00078                     \textcolor{keywordflow}{if}(target\_reg==0)\textcolor{keywordflow}{return} -1;     
00079                     \textcolor{keywordflow}{for}(ii=0;ii<samples;ii++)\{
00080                     \textcolor{keywordflow}{if}(\hyperlink{a00003_ga7b6d584350762c53419945480d6958d3}{wait\_new\_conversion}()==-1)\textcolor{keywordflow}{return} -1;
00081                     measured\_val += \hyperlink{a00007_ga7ad9f65ee46aca507374096506a0b1c4}{spi\_read}(BCM2835\_SPI\_CS0,
      \hyperlink{a00037_a94de2b046db6e10257ef4481c0a15eaa}{CHIP\_ADDRESS1},target\_reg,\textcolor{keyword}{sizeof}(uint32\_t)); 
00082                     \textcolor{keywordflow}{if}(ii%50 == 0)printf(\textcolor{stringliteral}{"#\(\backslash\)n"});\textcolor{keywordflow}{else} printf(\textcolor{stringliteral}{"#"});
00083                     
00084                     \}
00085                     measured\_val /=samples;
00086                     
00087                     \textcolor{keywordflow}{return} measured\_val/\hyperlink{a00037_a88b595bff6a462c91ddc1cafbd6e4140}{ILSB\_CONST};
00088                 
00089                 \}\textcolor{keywordflow}{break};
00090                 
00091                 
00092                 \textcolor{keywordflow}{case}  \hyperlink{a00043_a4ee773ad07fa969b9990f9bb3a1a2093}{PHASE\_ACTIVE\_WH}:\textcolor{comment}{/*considers also harmoics , trouble? then we change it
       to fundamental*/}
00093                 \{
00094             
00095                     uint16\_t target\_reg =  (channel==\hyperlink{a00043_ad214039f52b011ce2bd6c85ff98a981b}{PHASE\_A} )?\hyperlink{a00036_ae66c97ed86f47fd938f143a30a8b2f7e}{AWATTHR}
00096                                           :(channel==\hyperlink{a00043_ad7b96feed1e1c12515dad5e926b2c62e}{PHASE\_B} )?\hyperlink{a00036_a185c6910fa47f7e973f0f8743ef0e8ad}{BWATTHR}
00097                                           :(channel==\hyperlink{a00043_a3ceb83fb10c2af19b468d508448f24e2}{PHASE\_C} )?\hyperlink{a00036_ad685baf76950c0387bedffa9bb3272a9}{CWATTHR}
00098                                           :0;           
00099                                           
00100                     measured\_val = \hyperlink{a00007_ga7ad9f65ee46aca507374096506a0b1c4}{spi\_read}(BCM2835\_SPI\_CS0,
      \hyperlink{a00037_a94de2b046db6e10257ef4481c0a15eaa}{CHIP\_ADDRESS1},target\_reg,\textcolor{keyword}{sizeof}(uint32\_t));
00101                     printf(\textcolor{stringliteral}{"#"});
00102                     \textcolor{keywordflow}{return} measured\_val/\hyperlink{a00037_a75a052821a52067f93124e0c7ddcfdc3}{WHLSB\_CONST};
00103                 
00104                 \}\textcolor{keywordflow}{break};
00105                 
00106                 \textcolor{keywordflow}{case}  \hyperlink{a00043_ad8d2fc353ef124a8144e6d8264e43d1a}{TOTAL\_ACTIVE\_WH}:\textcolor{comment}{/*considers also harmoics */}
00107                 \{
00108                     
00109                     uint16\_t target\_reg =  (channel==\hyperlink{a00043_ad214039f52b011ce2bd6c85ff98a981b}{PHASE\_A} )?\hyperlink{a00036_ae66c97ed86f47fd938f143a30a8b2f7e}{AWATTHR}
00110                                           :(channel==\hyperlink{a00043_ad7b96feed1e1c12515dad5e926b2c62e}{PHASE\_B} )?\hyperlink{a00036_a185c6910fa47f7e973f0f8743ef0e8ad}{BWATTHR}
00111                                           :(channel==\hyperlink{a00043_a3ceb83fb10c2af19b468d508448f24e2}{PHASE\_C} )?\hyperlink{a00036_ad685baf76950c0387bedffa9bb3272a9}{CWATTHR}
00112                                           :0;           
00113                     
00114                      \textcolor{keywordflow}{return}  \hyperlink{a00009_gac914ebaa64afce03ee852af09659cf69}{measure}(\hyperlink{a00043_a4ee773ad07fa969b9990f9bb3a1a2093}{PHASE\_ACTIVE\_WH},
      \hyperlink{a00043_ad214039f52b011ce2bd6c85ff98a981b}{PHASE\_A},1)
00115                             +\hyperlink{a00009_gac914ebaa64afce03ee852af09659cf69}{measure}(\hyperlink{a00043_a4ee773ad07fa969b9990f9bb3a1a2093}{PHASE\_ACTIVE\_WH},
      \hyperlink{a00043_ad7b96feed1e1c12515dad5e926b2c62e}{PHASE\_B},1)
00116                             +\hyperlink{a00009_gac914ebaa64afce03ee852af09659cf69}{measure}(\hyperlink{a00043_a4ee773ad07fa969b9990f9bb3a1a2093}{PHASE\_ACTIVE\_WH},
      \hyperlink{a00043_a3ceb83fb10c2af19b468d508448f24e2}{PHASE\_C},1);
00117                      
00118                 
00119                 \}\textcolor{keywordflow}{break};
00120                 
00121                 \textcolor{keywordflow}{case}  \hyperlink{a00043_abd3f95c7cd63d0627552d293bf49e026}{PHASE\_ACTIVE\_POWER}:
00122                 \{
00123                     uint16\_t target\_reg =    (channel==\hyperlink{a00043_ad214039f52b011ce2bd6c85ff98a981b}{PHASE\_A} )?\hyperlink{a00036_a70d4c8c1577490f1b69cfab591458142}{AWATT}
00124                                             :(channel==\hyperlink{a00043_ad7b96feed1e1c12515dad5e926b2c62e}{PHASE\_B} )?\hyperlink{a00036_a3a60995ae993fd06892df7023a9f496c}{BWATT}
00125                                             :(channel==\hyperlink{a00043_a3ceb83fb10c2af19b468d508448f24e2}{PHASE\_C} )?\hyperlink{a00036_aeb58aae2f3e0c16a12cf4b6b03d6c5d9}{CWATT}
00126                                             :0;         
00127                                           
00128                     measured\_val = \hyperlink{a00007_ga7ad9f65ee46aca507374096506a0b1c4}{spi\_read}(BCM2835\_SPI\_CS0,
      \hyperlink{a00037_a94de2b046db6e10257ef4481c0a15eaa}{CHIP\_ADDRESS1},target\_reg,\textcolor{keyword}{sizeof}(uint32\_t));
00129                     printf(\textcolor{stringliteral}{"#"});
00130                     \textcolor{keywordflow}{return} measured\_val/\hyperlink{a00037_a218dca2818f6fa6923467998b967a084}{WATTLSB\_CONST};
00131                     
00132                 \}\textcolor{keywordflow}{break};
00133                 
00134                 \textcolor{keywordflow}{case}  \hyperlink{a00043_a7d0d4057be5aaf168a22ee4379e6ff30}{TOTAL\_ACTIVE\_POWER}:
00135                 \{
00136                 
00137                             
00138                      \textcolor{keywordflow}{return} \hyperlink{a00009_gac914ebaa64afce03ee852af09659cf69}{measure}(\hyperlink{a00043_abd3f95c7cd63d0627552d293bf49e026}{PHASE\_ACTIVE\_POWER},
      \hyperlink{a00043_ad214039f52b011ce2bd6c85ff98a981b}{PHASE\_A},1)
00139                             +\hyperlink{a00009_gac914ebaa64afce03ee852af09659cf69}{measure}(\hyperlink{a00043_abd3f95c7cd63d0627552d293bf49e026}{PHASE\_ACTIVE\_POWER},
      \hyperlink{a00043_ad7b96feed1e1c12515dad5e926b2c62e}{PHASE\_B},1);
00140                             +\hyperlink{a00009_gac914ebaa64afce03ee852af09659cf69}{measure}(\hyperlink{a00043_abd3f95c7cd63d0627552d293bf49e026}{PHASE\_ACTIVE\_POWER},
      \hyperlink{a00043_a3ceb83fb10c2af19b468d508448f24e2}{PHASE\_C},1);
00141                     
00142                 \}\textcolor{keywordflow}{break};
00143                 
00144                 \textcolor{keywordflow}{default}:
00145                 \{    
00146                   \textcolor{comment}{// return -1;}
00147                 \}\textcolor{keywordflow}{break};
00148      
00149         \}
00150 \}
00152  
00153  
00164 
\hypertarget{a00042_source_l00165}{}\hyperlink{a00009_gab120dc4bec6b4097a5cd3ebb91131c57}{00165} uint16\_t  \hyperlink{a00009_gab120dc4bec6b4097a5cd3ebb91131c57}{hex2val}(uint8\_t cc)
00166 \{
00167     \textcolor{keywordflow}{return}  (uint16\_t)(((cc >= \textcolor{charliteral}{'0'} ) && (cc <= \textcolor{charliteral}{'9'} )) ? (cc - \textcolor{charliteral}{'0'}) : (cc - \textcolor{charliteral}{'A'} + 10) );
00168      
00169 \}
00171 
00184 
\hypertarget{a00042_source_l00185}{}\hyperlink{a00009_ga1e74920f34a07a82cca58eab71ed12b3}{00185} uint16\_t  \hyperlink{a00009_ga1e74920f34a07a82cca58eab71ed12b3}{make16}(uint8\_t* buf,uint16\_t idx)
00186 \{
00187     \textcolor{keywordflow}{return} ((\hyperlink{a00009_gab120dc4bec6b4097a5cd3ebb91131c57}{hex2val}(buf[idx+0])<<12)|(\hyperlink{a00009_gab120dc4bec6b4097a5cd3ebb91131c57}{hex2val}(buf[idx+1])<<8)|(
      \hyperlink{a00009_gab120dc4bec6b4097a5cd3ebb91131c57}{hex2val}(buf[idx+2])<<4)|(\hyperlink{a00009_gab120dc4bec6b4097a5cd3ebb91131c57}{hex2val}(buf[idx+3])<<0));    
00188 
00189 \}
00191 
00205 
00206 
\hypertarget{a00042_source_l00207}{}\hyperlink{a00009_gaefa26c3e5b22ccbe5de1c33305f20e1b}{00207} uint8\_t  \hyperlink{a00009_gaefa26c3e5b22ccbe5de1c33305f20e1b}{make8}(uint8\_t* buf,uint16\_t idx)
00208 \{
00209     \textcolor{keywordflow}{return} (uint8\_t)((\hyperlink{a00009_gab120dc4bec6b4097a5cd3ebb91131c57}{hex2val}(buf[idx+0])<<4)|(\hyperlink{a00009_gab120dc4bec6b4097a5cd3ebb91131c57}{hex2val}(buf[idx+1]))<<0);    
00210 \}
00211 
00213 
\end{DoxyCode}
